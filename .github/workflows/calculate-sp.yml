name: Calculate SP and add comment

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  calculate-sp-and-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Use Node.js 16
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Calculate SP and add comment
        id: calculate_sp
        uses: actions/github-script@v4
        with:
          script: |
            const { github, context } = require("@actions/github");

            const issue = context.payload.issue;
            const body = issue.body;

            // Extract the selected attributes from the issue body
            const matches = body.match(/uncertainty: (small|medium|large), complexity: (small|medium|large), effort: (small|medium|large)/);
            if (!matches) {
              console.log('Required fields are missing from the issue body. Skipping SP calculation and comment addition.');
              return;
            }

            const [, uncertainty, complexity, effort] = matches;

            // Define the SPT table
            const sptTable = {
              small: {
                small: {
                  small: 1,
                  medium: 2,
                  large: 5
                },
                medium: {
                  small: 2,
                  medium: 3,
                  large: 5
                },
                large: {
                  small: 3,
                  medium: 5,
                  large: 8
                }
              },
              medium: {
                small: {
                  small: 3,
                  medium: 5,
                  large: 8
                },
                medium: {
                  small: 5,
                  medium: 5,
                  large: 8
                },
                large: {
                  small: 6,
                  medium: 8,
                  large: 13
                }
              },
              large: {
                small: {
                  small: 8,
                  medium: 8,
                  large: 13
                },
                medium: {
                  small: 8,
                  medium: 8,
                  large: 13
                },
                large: {
                  small: 8,
                  medium: 13,
                  large: 13
                }
              }
            };

            // Retrieve the corresponding SP value from the SPT table
            const sp = sptTable[uncertainty][complexity][effort];

            // Create the comment body
            const commentBody = `The calculated SP value is: ${sp}`;

            console.log('SP:', sp);
            console.log('Comment body:', commentBody);

            // Add a comment to the issue
            const octokit = github.getOctokit(process.env.GITHUB_TOKEN);
            await octokit.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: commentBody
            });

            return sp;

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
